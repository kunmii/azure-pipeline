trigger:
- main
variables:
    # Container registry service connection established during pipeline creation
    # dockerRegistryServiceConnection: '{{ containerRegistryConnection.Id }}'
    # imageRepository: 'test'
    # containerRegistry: 'kunmipipelinetest.azurecr.io'
    # dockerfilePath: '$(Build.SourcesDirectory)/app/Dockerfile'
    azureSubscription: 'tochipipelinetest'
    tag: '$(Build.BuildId)'
pool:
  vmImage: ubuntu-latest

steps:
- script: echo Hello, world! Can you see this?
  displayName: 'Run a one-line script'
- task: Docker@2 
  displayName: Build and push an image to container registry
  inputs:
    containerRegistry: 'kunmipipelinetest'
    repository: 'testing'
    command: 'buildAndPush'
    Dockerfile: '**/test/Dockerfile'
    tags: '$(tag)'
    addPipelineData: false

- task: Kubernetes@1
  displayName: 'Deploy to kubernetes'
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscriptionEndpoint: '$(azureSubscription)'
    azureResourceGroup: 'pipelinetest'
    kubernetesCluster: 'akspipelinecluster'
    namespace: 'default'
    command: 'apply'
    arguments: '-f ./deployment.yml'
    secretType: 'dockerRegistry' # If needed, specify the secret type
    dockerRegistryEndpoint: 'kunmipipelinetest' # Use your Docker registry service connection name
    dockerRegistryServiceConnection: 'kunmipipelinetest' # Use your Docker registry service connection name
    containerRegistryType: 'Azure Container Registry'
    # dockerRegistryServiceConnectionSecretName: 'your-secret-name' # Name of the Kubernetes secret containing your ACR credentials\
    # overrideOptions: '--set=image.tag=$(Build.BuildId)'  # Pass the dynamic tag to the Kubernetes manifest